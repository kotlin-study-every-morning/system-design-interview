## 문제 이해 및 설계 범위 확정

### 기능적 요구사항
- 파일 추가
- 파일 다운로드
- 여러 단말에 파일 동기화
- 파일 갱신 이력 조회
- 파일 공유
- 파일 편집, 삭제 및 새로운 공유 알림

### 비-기능적 요구사항
- 안정성 : 데이터 손실 방지
- 빠른 동기화 속도 : 빠른 사용자 편의성
- 네트워크 대역폭 : 빠른 다운로드 / 업로드 속도
- 규모 확장성 : 많은 양의 트래픽 처리
- 높은 가용성 : 장애 발생 방지

### 개략적 추정치
- 가입 사용자 : 5천만
- DAU : 천만
- 모든 사용자에게 10GB 무료 저장 공간 할당
- 매일 각 사용자는 2개의 파일 업로드
- 각 파일 크기 : 500KB
- 읽기:쓰기 비율 : 1:1
- 필요 저장 공간 : 5천만 * 10GB = 500PB
- 업로드 API QPS : 천만 * 2회 / 24시간 / 3600초 = 240
- 최대 QPS = QPS * 2 = 480

## 개략적 설계안 제시 및 동의 구하기

### API
1. 파일 업로드 API
    - 단순 업로드
    - 이어올리기
2. 파일 다운로드 API
3. 파일 갱신 히스토리 API

### 한대 서버의 제약 극복
- 로드밸런서 적용
- 웹 서버 추가
- 메타 데이터 데이터 베이스
- 파일 저장소

### 동기화 충돌
> 두명 이상의 사용자가 같은 파일이나 폴더를 동시에 업데이트 하려고 할 때 발생하는 충돌 상황
- 오류 발생 시점의 같은 파일의 두가지 버전을 합칠지 대체 할지 결정

### 개략적 설계안
- 사용자 단말
- 블록 저장소 서버
- 클라우드 저장소
- 아카이빙 저장소
- 로드밸런서
- API 서버
- 메타데이터 데이터베이스
- 메타데이터 캐시
- 알림 서비스
- 오프라인 사용자 백업 큐

## 상세 설계

### 블록 저장소 서버
> 정기적으로 갱신되는 큰 파일을 전송하기 위한 최적화 방법, 네트워크 대역폭 사용량 절감 효과

- 델타 동기화 : 파일 수정시 수정이 일어난 블록만 동기화
- 압축 : 블록 단위로 압축해 데이터 크기 축소
  - 텍스트 파일 압축시에는 gzip, bzip2 / 이미지나 비디오 압축시는 다른 압축 알고리즘 사용

### 높은 일관성 요구사항
> 모든 사용자에게 같은 파일이 보이도록 지원

- ACID를 보장하는 관계형 데이터 베이스를 이용해 강한 일관성 보장

### 메타데이터 데이터베이스
#### 저장 데이터
- 사용자
- 디바이스 정보
- 디렉토리 정보
- 파일의 최신 정보
- 파일의 갱신 이력
- 파일 블록 정보

### 업로드 절차
- 파일 메타데이터 추가
- 파일을 클라우드 저장소에 업로드

### 다운로드 절차
1. 파일 변경 알림
2. 클라이언트는 새로운 메타 데이터 요청 -> API 서버 -> 메타 데이터 데이터베이스 -> 반환
3. 클라이언트는 블록 다운로드 요청
4. 클라우드 저장소에서 블록 서버에서 요청된 블록 반환
5. 전송된 블록을 통해 파일 재구성

### 알림 서비스
> 파일의 일관성을 유지하기 위해 각 클라이언트에 알려 충돌 가능성 방지 방법
- 롱 폴링
- 웹소켓

### 저장소 공간 절약
- 중복 제거
- 지능적 백업 전략 도입
  - 한도 설정
  - 중요한 버전만 보관
- 비 주기적 데이터는 아카이빙 저장소로 이관

### 장애 처리
- 로드 밸런서 장애
- 블록 저장소 서버 장애
- 클라우드 저장소 장애
- API 서버 장애
- 메타데이터 캐시 장애
- 메타데이터 데이터베이스 장애
- 알림 서비스 장애
- 오프라인 사용자 백업 큐 장애